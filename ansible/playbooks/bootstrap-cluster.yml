---
- name: Initialize Kubernetes control plane
  hosts: control_plane
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Check if cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeadm_init_stat
    
    - name: Initialize Kubernetes cluster with kubeadm
      command: >
        kubeadm init
        --pod-network-cidr={{ pod_network_cidr }}
        --service-cidr={{ service_cidr }}
        --apiserver-advertise-address={{ ansible_host }}
        --node-name={{ hostname }}
      when: not kubeadm_init_stat.stat.exists
      register: kubeadm_init_output
    
    - name: Display kubeadm init output
      debug:
        var: kubeadm_init_output.stdout_lines
      when: kubeadm_init_output is defined and kubeadm_init_output.changed
    
    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'
        owner: root
        group: root
    
    - name: Copy admin.conf to root user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        mode: '0600'
        owner: root
        group: root
    
    - name: Create .kube directory for regular user
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        mode: '0755'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
    
    - name: Copy admin.conf to regular user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: yes
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
    
    - name: Wait for API server to be responsive
      shell: |
        kubectl get nodes
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: api_check
      retries: 10
      delay: 10
      until: api_check.rc == 0
      changed_when: false
    
    - name: Check if Flannel is already installed
      shell: |
        kubectl get daemonset -n kube-flannel kube-flannel-ds 2>/dev/null
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: flannel_check
      failed_when: false
      changed_when: false
    
    - name: Install Flannel CNI
      shell: |
        kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      when: flannel_check.rc != 0
      register: flannel_install
    
    - name: Display Flannel installation output
      debug:
        var: flannel_install.stdout_lines
      when: flannel_install is defined and flannel_install.changed
    
    - name: Wait for Flannel DaemonSet to be created
      shell: |
        kubectl get daemonset -n kube-flannel kube-flannel-ds
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: flannel_ds
      retries: 30
      delay: 5
      until: flannel_ds.rc == 0
      changed_when: false
    
    - name: Wait for Flannel pods to be ready
      shell: |
        kubectl wait --for=condition=Ready pods --all -n kube-flannel --timeout=300s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      retries: 3
      delay: 30
      register: flannel_ready
      until: flannel_ready.rc == 0
      failed_when: false
    
    - name: Check Flannel pod status if wait failed
      shell: |
        kubectl get pods -n kube-flannel -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: flannel_pods_status
      when: flannel_ready.rc != 0
      changed_when: false
    
    - name: Display Flannel pod status
      debug:
        var: flannel_pods_status.stdout_lines
      when: flannel_ready.rc != 0 and flannel_pods_status is defined
    
    - name: Wait for control plane node to be Ready
      shell: |
        kubectl get nodes {{ hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: node_ready_check
      retries: 30
      delay: 10
      until: node_ready_check.stdout == "True"
      changed_when: false
    
    - name: Wait for kube-system pods to be ready (with longer timeout)
      shell: |
        kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=600s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      retries: 2
      delay: 30
      register: kube_system_ready
      until: kube_system_ready.rc == 0
      failed_when: false
    
    - name: Check pod status if wait failed
      shell: |
        kubectl get pods -A -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: all_pods_status
      when: kube_system_ready.rc != 0
      changed_when: false
    
    - name: Display pod status for troubleshooting
      debug:
        var: all_pods_status.stdout_lines
      when: kube_system_ready.rc != 0 and all_pods_status is defined
    
    - name: Generate join command for worker nodes
      command: kubeadm token create --print-join-command
      register: join_command
      changed_when: false
    
    - name: Save join command to local file
      local_action:
        module: copy
        content: "{{ join_command.stdout }}"
        dest: /tmp/k8s-join-command.sh
        mode: '0755'
      become: no
    
    - name: Display cluster status
      shell: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cluster_nodes
      changed_when: false
    
    - name: Show cluster nodes
      debug:
        var: cluster_nodes.stdout_lines

- name: Join worker nodes to cluster
  hosts: workers
  become: yes
  gather_facts: yes
  serial: 1
  
  tasks:
    - name: Check if node is already part of cluster
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf
    
    - name: Copy join command to worker node
      copy:
        src: /tmp/k8s-join-command.sh
        dest: /tmp/k8s-join-command.sh
        mode: '0755'
      when: not kubelet_conf.stat.exists
    
    - name: Join worker node to cluster
      command: bash /tmp/k8s-join-command.sh
      when: not kubelet_conf.stat.exists
      register: join_result
    
    - name: Display join result
      debug:
        var: join_result.stdout_lines
      when: join_result is defined and join_result.changed
    
    - name: Remove join command file
      file:
        path: /tmp/k8s-join-command.sh
        state: absent
    
    - name: Wait for node to join
      pause:
        seconds: 15
      when: join_result is defined and join_result.changed

- name: Label and verify worker nodes
  hosts: control_plane
  become: yes
  gather_facts: no
  
  tasks:
    - name: Wait for all nodes to be registered
      shell: |
        kubectl get nodes --no-headers | wc -l
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: node_count
      until: node_count.stdout|int == 3
      retries: 20
      delay: 10
    
    - name: Label worker nodes
      shell: |
        kubectl label node {{ hostvars[item]['hostname'] }} node-role.kubernetes.io/worker=worker --overwrite
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      loop: "{{ groups['workers'] }}"
      failed_when: false
    
    - name: Wait for all nodes to be Ready
      shell: |
        kubectl get nodes --no-headers | grep -v "NotReady" | wc -l
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: ready_nodes
      until: ready_nodes.stdout|int == 3
      retries: 30
      delay: 10
    
    - name: Display final cluster status
      shell: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: final_cluster_status
      changed_when: false
    
    - name: Show final cluster status
      debug:
        var: final_cluster_status.stdout_lines
    
    - name: Display all pods status
      shell: kubectl get pods -A -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: all_pods
      changed_when: false
    
    - name: Show all pods
      debug:
        var: all_pods.stdout_lines
    
    - name: Display cluster summary
      debug:
        msg:
          - "=========================================="
          - "âœ“ Kubernetes Cluster Bootstrap Complete!"
          - "=========================================="
          - ""
          - "Cluster Info:"
          - "  - Nodes: {{ node_count.stdout }}"
          - "  - Ready Nodes: {{ ready_nodes.stdout }}"
          - "  - CNI: Flannel"
          - ""
          - "Next Steps:"
          - "  1. Setup NFS Storage Provisioner"
          - "  2. Install FluxCD for GitOps"
          - "=========================================="
